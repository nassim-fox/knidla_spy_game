<!DOCTYPE html>
<html>
<head>
    <title>üß† Kalak Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        body { font-family: sans-serif; background: #2c3e50; color: white; text-align: center; padding: 20px; }
        .card { background: white; color: #333; padding: 20px; border-radius: 15px; max-width: 500px; margin: 0 auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .question { font-size: 1.3em; font-weight: bold; margin-bottom: 20px; color: #2c3e50; padding: 10px; background: #ecf0f1; border-radius: 8px; }
        .input-box { width: 80%; padding: 15px; font-size: 1.1em; border: 2px solid #ccc; border-radius: 8px; outline: none; transition: 0.3s; }
        .input-box:focus { border-color: #e67e22; }
        .btn { padding: 15px; background: #e67e22; color: white; border:none; border-radius: 8px; width: 100%; font-size: 1.1em; margin-top: 15px; cursor: pointer; transition: 0.2s; }
        .btn:hover { background: #d35400; transform: translateY(-2px); }
        .btn-vote { background: #3498db; margin-bottom: 10px; font-weight: bold; }
        .btn-vote:hover { background: #2980b9; }
        .score-board { font-size: 1.2em; background: rgba(0,0,0,0.3); padding: 10px 20px; border-radius: 20px; display: inline-block; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.2); }
        .wait-box { padding: 30px; background: #eef2f3; color: #7f8c8d; border-radius: 10px; border: 2px dashed #bdc3c7; }
        .msg-box { padding: 10px; border-radius: 5px; margin-bottom: 15px; font-weight: bold; }
        .msg-error { background: #e74c3c; color: white; }
        .msg-warning { background: #f39c12; color: white; }
        
        /* New Result Styles */
        .big-score { font-size: 2em; color: #f1c40f; text-shadow: 1px 1px 0 #000; margin: 10px 0; }
    </style>
</head>
<body>

    <div class="score-board">
        üîÑ Round: {{ round_num }}/20
    </div>

    <div class="card animate__animated animate__fadeInUp">

        {% if messages %}
            {% for message in messages %}
                <div class="msg-box {% if message.tags %}msg-{{ message.tags }}{% endif %} animate__animated animate__shakeX">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}


        {% if not game.is_active and game.kalak_phase != 'GAME_OVER' %}
            <h2>üé≠ Kalak Game</h2>
            <p style="color:#7f8c8d; font-size:0.9em; margin-bottom:20px;">
                Invent fake answers. Fool your friends. Win points.<br>
                <strong>First to 20 rounds wins!</strong>
            </p>
            <form action="{% url 'start_kalak' %}" method="POST">
                {% csrf_token %}
                <button type="submit" class="btn">üöÄ Start First Round</button>
            </form>


        {% elif game.kalak_phase == 'GAME_OVER' %}
            <h1 style="color:#2ecc71;">üèÜ GAME OVER!</h1>
            <div class="big-score">{{ my_score }} pts</div>
            <p>Final Score</p>
            
            <form action="{% url 'switch_game' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="game_type" value="KALAK">
                <button class="btn" style="background: #27ae60;">üîÑ Play Again (Reset Scores)</button>
            </form>


        {% else %}

            {% if game.kalak_phase == 'WRITING' %}
                <div class="question">{{ game.kalak_question }}</div>

                {% if has_acted %}
                    <div class="wait-box">
                        <h3>‚úÖ Lie Submitted!</h3>
                        <p>You wrote: <strong>{{ my_bluff.text }}</strong></p>
                        <p class="animate__animated animate__pulse animate__infinite">Waiting for others...</p>
                    </div>
                {% else %}
                    <form action="{% url 'submit_bluff' %}" method="POST">
                        {% csrf_token %}
                        <p>Invent a Fake Answer!</p>
                        <input type="text" name="bluff_text" class="input-box" placeholder="Your lie here..." required autocomplete="off" autofocus>
                        <button type="submit" class="btn">Submit Lie ü§•</button>
                    </form>
                {% endif %}
            {% endif %}


            {% if game.kalak_phase == 'VOTING' %}
                <div class="question">{{ game.kalak_question }}</div>

                {% if has_acted %}
                    <div class="wait-box">
                        <h3>üó≥Ô∏è Vote Locked In!</h3>
                        <p class="animate__animated animate__pulse animate__infinite">Waiting for others to vote...</p>
                    </div>
                {% else %}
                    <p>Pick the REAL answer:</p>
                    {% for opt in options %}
                        <form action="{% url 'vote_kalak' %}" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="choice_id" value="{{ opt.id }}">
                            {% if opt.text != my_bluff.text %}
                                <button type="submit" class="btn btn-vote">{{ opt.text }}</button>
                            {% else %}
                                <button disabled class="btn" style="background:#bdc3c7; cursor:not-allowed; opacity: 0.7;">
                                    {{ opt.text }} (Your Lie)
                                </button>
                            {% endif %}
                        </form>
                    {% endfor %}
                {% endif %}
            {% endif %}


            {% if game.kalak_phase == 'RESULTS' %}
                <h2>üìä Results</h2>
                
                <div style="background: #34495e; color: #f1c40f; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div>Your Total Score:</div>
                    <div class="big-score">{{ my_score }}</div>
                </div>

                <div style="text-align:left; margin-bottom: 20px;">
                    <div style="background: #2ecc71; color:white; padding:15px; border-radius:8px; margin-bottom:15px;">
                        ‚úÖ Real Answer: <strong>{{ game.kalak_real_answer }}</strong>
                    </div>

                    {% if all_bluffs %}
                        {% for bluff in all_bluffs %}
                            <div style="border-bottom:1px solid #eee; padding:10px 5px;">
                                <span style="font-size:1.1em;">ü§• <strong>{{ bluff.text }}</strong></span>
                                <br>
                                <span style="font-size:0.8em; color:#7f8c8d;">by {{ bluff.player.username }}</span>
                                {% if bluff.voters.all %}
                                    <div style="margin-top:5px; background:#ffecec; color:#c0392b; padding:5px; border-radius:5px; font-size:0.9em;">
                                        Fooled: <strong>{% for v in bluff.voters.all %}{{ v.username }}, {% endfor %}</strong>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <p style="color:#7f8c8d; font-style:italic;">No bluffs submitted.</p>
                    {% endif %}
                </div>

                <form action="{% url 'start_kalak' %}" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="btn">Next Question ‚û°Ô∏è</button>
                </form>
            {% endif %}

        {% endif %} 
    </div>

    <form action="{% url 'switch_game' %}" method="POST" style="margin-top: 50px;">
        {% csrf_token %}
        <input type="hidden" name="game_type" value="SPY">
        <button style="background: #34495e; color: #bdc3c7; padding: 8px 15px; border:none; border-radius: 5px; cursor:pointer;">
            ‚¨ÖÔ∏è Quit to Spy Game
        </button>
    </form>

    <script>
        let localTimestamp = "{{ game.updated_at|date:'c' }}";
        setInterval(() => {
            fetch("{% url 'game_status' %}")
                .then(r => r.json())
                .then(d => { if(d.last_updated !== localTimestamp) window.location.reload(); });
        }, 2000);
    </script>
</body>
</html>