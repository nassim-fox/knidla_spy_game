<!DOCTYPE html>
<html>
<head>
    <title>üß† Kalak Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        body { font-family: sans-serif; background: #2c3e50; color: white; text-align: center; padding: 20px; }
        .card { background: white; color: #333; padding: 20px; border-radius: 15px; max-width: 500px; margin: 0 auto; }
        .question { font-size: 1.3em; font-weight: bold; margin-bottom: 20px; color: #2c3e50; }
        .input-box { width: 80%; padding: 10px; font-size: 1.2em; border: 2px solid #ccc; border-radius: 5px; }
        .btn { padding: 15px; background: #e67e22; color: white; border:none; border-radius: 8px; width: 100%; font-size: 1.1em; margin-top: 10px; cursor: pointer; }
        .btn-vote { background: #3498db; margin-bottom: 10px; }
        .score { font-size: 0.9em; color: #f1c40f; margin-bottom: 20px; }
        .wait-msg { color: #7f8c8d; font-style: italic; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="score">‚≠ê My Points: {{ my_score }}</div>

    <div class="card animate__animated animate__fadeInUp">
        
        {% if game.kalak_phase == 'WRITING' %}
            <div class="question">{{ game.kalak_question }}</div>

            {% if my_bluff %}
                <div style="padding: 20px; background: #e8f6f3; color: #16a085; border-radius: 10px;">
                    ‚úÖ You wrote: <strong>{{ my_bluff.text }}</strong>
                </div>
                <p class="wait-msg">Waiting for other players...</p>
            {% else %}
                <form action="{% url 'submit_bluff' %}" method="POST">
                    {% csrf_token %}
                    <p>Invent a Fake Answer!</p>
                    <input type="text" name="bluff_text" class="input-box" placeholder="Your lie here..." required autocomplete="off">
                    <button type="submit" class="btn">Submit Lie ü§•</button>
                </form>
            {% endif %}

            <form action="{% url 'advance_phase' %}" method="POST" style="margin-top:30px;">
                {% csrf_token %}
                <button style="background:none; border:none; color:#999; text-decoration:underline; cursor:pointer;">
                    Admin: Everyone finished? Go to Voting >>
                </button>
            </form>
        {% endif %}


        {% if game.kalak_phase == 'VOTING' %}
            <div class="question">{{ game.kalak_question }}</div>
            <p>Pick the REAL answer:</p>

            {% for opt in options %}
                <form action="{% url 'vote_kalak' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="choice_id" value="{{ opt.id }}">
                    {% if opt.text != my_bluff.text %}
                        <button type="submit" class="btn btn-vote">{{ opt.text }}</button>
                    {% else %}
                        <button disabled class="btn" style="background:#ccc;">{{ opt.text }} (Your Lie)</button>
                    {% endif %}
                </form>
            {% endfor %}

            <form action="{% url 'advance_phase' %}" method="POST" style="margin-top:30px;">
                {% csrf_token %}
                <button style="background:none; border:none; color:#999; text-decoration:underline;">
                    Admin: Go to Results >>
                </button>
            </form>
        {% endif %}


        {% if game.kalak_phase == 'RESULTS' %}
            <h2>üìä Results</h2>
            
            <div style="text-align:left; margin-bottom: 20px;">
                <div style="background: #2ecc71; color:white; padding:10px; border-radius:5px; margin-bottom:10px;">
                    ‚úÖ Real Answer: <strong>{{ game.kalak_real_answer }}</strong>
                </div>

                <h3>Lies that fooled people:</h3>
                {% for bluff in all_bluffs %}
                    <div style="border-bottom:1px solid #eee; padding:5px;">
                        <strong>{{ bluff.text }}</strong> (by {{ bluff.player.username }})
                        <br>
                        <span style="font-size:0.8em; color:#e74c3c;">
                            Fooled: {% for v in bluff.voters.all %}{{ v.username }}, {% endfor %}
                        </span>
                    </div>
                {% endfor %}
            </div>

            <form action="{% url 'start_kalak' %}" method="POST">
                {% csrf_token %}
                <button type="submit" class="btn">Next Question ‚û°Ô∏è</button>
            </form>
        {% endif %}

    </div>

    <form action="{% url 'switch_game' %}" method="POST" style="margin-top: 50px;">
        {% csrf_token %}
        <input type="hidden" name="game_type" value="SPY">
        <button style="background: #7f8c8d; color: white; padding: 5px 10px; border:none; border-radius: 5px;">
            ‚¨ÖÔ∏è Back to Spy Game
        </button>
    </form>

    <script>
        // Auto-refresh script (same as Spy game)
        let localTimestamp = "{{ game.updated_at|date:'c' }}";
        setInterval(() => {
            fetch("{% url 'game_status' %}")
                .then(r => r.json())
                .then(d => { if(d.last_updated !== localTimestamp) window.location.reload(); });
        }, 2000);
    </script>

</body>
</html>