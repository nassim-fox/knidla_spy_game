{% extends 'core/base.html' %}

{% block content %}
<div class="glass-card animate__animated animate__fadeInUp">
    <div style="margin-bottom: 20px;">
        <span style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; color: #ccc;">Room Code</span>
        <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
            <h1 style="font-size: 3.5rem; color: var(--accent); margin: 10px 0; letter-spacing: 5px;">{{ game.room_code }}</h1>
            <button onclick="copyToClipboard('{{ game.room_code }}')" class="btn btn-outline" style="width: auto; padding: 10px;">
                <i class="fas fa-copy"></i>
            </button>
        </div>
    </div>

    <h3 style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
        <i class="fas fa-users"></i> Players ({{ players|length }})
    </h3>
    
    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 30px;">
        {% for player in players %}
        <div class="animate__animated animate__bounceIn" style="background: rgba(0,0,0,0.3); padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px; border: 1px solid #3a7bd5;">
            <img src="{{ player.playerscore.avatar_url }}" style="width: 25px; height: 25px; border-radius: 50%;">
            <span>{{ player.username }}</span>
            {% if player == game.admin %}
                <i class="fas fa-crown" style="color: gold;"></i>
            {% endif %}
            
            {% if is_admin and player != request.user %}
                <form action="{% url 'kick_player' player.id %}" method="POST" style="margin: 0;">
                    {% csrf_token %}
                    <button type="submit" style="background: none; border: none; color: #ff4757; cursor: pointer; margin-left: 5px;">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </form>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    {% if is_admin %}
        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px;">
            <h3 style="margin-bottom: 15px;">Choose Game Mode</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <form action="{% url 'switch_game' %}" method="POST"> {% csrf_token %}
                    <input type="hidden" name="game_type" value="SPY">
                    <button class="btn {% if game.current_game == 'SPY' %}btn-primary{% else %}btn-outline{% endif %}">
                        <i class="fas fa-user-secret"></i><br>SPY
                    </button>
                </form>

                <form action="{% url 'switch_game' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="game_type" value="KALAK">
                    <button class="btn {% if game.current_game == 'KALAK' %}btn-success{% else %}btn-outline{% endif %}">
                        <i class="fas fa-mask"></i><br>KALAK
                    </button>
                </form>
            </div>

            <div style="margin-top: 20px;">
                {% if game.current_game == 'SPY' %}
                    <form action="{% url 'start_round' %}" method="POST">
                        {% csrf_token %}
                        <button class="btn btn-accent animate__animated animate__pulse animate__infinite">START SPY ROUND</button>
                    </form>
                {% elif game.current_game == 'KALAK' %}
                    <form action="{% url 'start_kalak' %}" method="POST">
                        {% csrf_token %}
                        <button class="btn btn-accent animate__animated animate__pulse animate__infinite">START KALAK</button>
                    </form>
                {% endif %}
            </div>
        </div>
    {% else %}
        <div style="padding: 20px; color: #aaa;">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Waiting for host to start...</p>
        </div>
    {% endif %}

    <form action="{% url 'leave_room' %}" method="POST" style="margin-top: 30px;">
        {% csrf_token %}
        <button class="btn btn-outline" style="border-color: #ff4757; color: #ff4757;">Leave Room</button>
    </form>
</div>

<script>
    let lastUpdate = "{{ game.updated_at|date:'c' }}";
    
    // Check for updates every 2 seconds
    setInterval(() => {
        fetch("{% url 'game_status' %}")
            .then(r => r.json())
            .then(d => { 
                if(d.last_updated !== lastUpdate) {
                    // Fade out before reload for smoother feel
                    document.body.style.opacity = 0; 
                    setTimeout(() => location.reload(), 300);
                }
            })
            .catch(e => console.log("Connection lost?"));
    }, 2500);
</script>
{% endblock %}